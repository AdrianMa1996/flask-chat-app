<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>Page Title</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='basic_styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='index_styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
</head>
<body>
    <div class="ApplicationContainer">
        <div class="NavContainer">
            <p class="left bigFont">{{ current_user.username }}</p>
            <p class="center bigFont">WebChat</p>
            <a class="right logoutButton" href="{{ url_for_security('logout') }}">Logout</a>
        </div>

        <div class="chatContainer">
            <div class="chatMessageContainer right">
                <div class="messageContainer">
                    {% for message in messages %}
                    <div class="d-flex {%if current_user.id == message.sender_id%} justify-content-end {% else %} justify-content-start {% endif %} mt-5">
                        <div class="card">
                            <div class="card-body">
                                <b>{{ message.sender_name }}:</b>
                                {{ message.content }}
            
                                <span class="messageDate">{{ message.created_at.strftime('%d.%m.%Y %H:%m') }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            
                <div class="chatFormContainer">
                    <form class="chatForm" action="" method="post">
                        <input type="text" name="content" class="chatMessageInput" placeholder="Bitte gebe deine Nachricht an">
                        <button class="chatMessageSubmit" type="submit" id="button-addon2">Senden</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            var socket = io();
            var current_user_id = {{ current_user.id }};

            function scrollToBottom() {
                const messageContainer = document.querySelector(".messageContainer");
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            socket.emit("send_message");

            socket.on("receive_message", function(data) {
                const messages = data.messages;
                const messageContainer = document.querySelector(".messageContainer");

                messageContainer.innerHTML = '';

                messages.forEach(message => {
                    const messageDiv = document.createElement("div");
                    messageDiv.classList.add("d-flex", message.sender_id == current_user_id ? "justify-content-end" : "justify-content-start", "mt-5");
                
                    const cardDiv = document.createElement("div");
                    cardDiv.classList.add("card");

                    const cardBodyDiv = document.createElement("div");
                    cardBodyDiv.classList.add("card-body");

                    const boldText = document.createElement("b");
                    boldText.textContent = `${message.sender_name}:`;
                    cardBodyDiv.appendChild(boldText);

                    const messageText = document.createTextNode(` ${message.content}`);
                    cardBodyDiv.appendChild(messageText);

                    const spanDate = document.createElement("span");
                    spanDate.classList.add("messageDate");
                    spanDate.textContent = new Date(message.created_at).toLocaleString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'});
                    cardBodyDiv.appendChild(spanDate);

                    cardDiv.appendChild(cardBodyDiv);
                    messageDiv.appendChild(cardDiv);
                    messageContainer.appendChild(messageDiv);
                });

                scrollToBottom();
            });

            scrollToBottom();
        });
    </script>
</body>
</html>